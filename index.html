<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
<title>QR â†’ CSV</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Syne:wght@400;600;800&family=JetBrains+Mono:wght@400;600&display=swap');
  *,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
  :root{
    --bg:#08090b;--surf:#111318;--surf2:#181b22;--border:#1f2330;
    --accent:#f0c040;--green:#3ddc84;--red:#ff5555;--blue:#4fa3ff;
    --text:#dde1ec;--muted:#4a5068;
  }
  body{background:var(--bg);color:var(--text);font-family:'Syne',sans-serif;
    display:flex;flex-direction:column;align-items:center;
    min-height:100vh;padding:22px 16px 80px}

  .hdr{text-align:center;margin-bottom:20px}
  .hdr h1{font-size:clamp(1.5rem,5vw,2rem);font-weight:800;letter-spacing:-.03em;color:var(--accent)}
  .hdr p{font-family:'JetBrains Mono',monospace;font-size:.7rem;color:var(--muted);margin-top:5px}

  .wrap{width:100%;max-width:520px;display:flex;flex-direction:column;gap:14px}

  .card{background:var(--surf);border:1px solid var(--border);border-radius:14px;padding:18px}
  .clabel{font-family:'JetBrains Mono',monospace;font-size:.62rem;text-transform:uppercase;
    letter-spacing:.14em;color:var(--muted);margin-bottom:11px}

  /* camera */
  .cam-wrap{position:relative;width:100%;aspect-ratio:1;border-radius:10px;
    overflow:hidden;background:#000;border:1px solid var(--border)}
  #video{width:100%;height:100%;object-fit:cover;display:block}
  #canvas{display:none}

  .scan-line{position:absolute;left:8%;right:8%;height:2px;
    background:var(--accent);box-shadow:0 0 10px var(--accent),0 0 26px var(--accent);
    animation:scanmove 2s ease-in-out infinite;display:none;z-index:4}
  @keyframes scanmove{0%{top:10%}50%{top:88%}100%{top:10%}}

  .br{position:absolute;inset:0;pointer-events:none;z-index:3;display:none}
  .br span{position:absolute;width:26px;height:26px;border-color:var(--accent);border-style:solid}
  .br span:nth-child(1){top:8px;left:8px;border-width:3px 0 0 3px}
  .br span:nth-child(2){top:8px;right:8px;border-width:3px 3px 0 0}
  .br span:nth-child(3){bottom:8px;left:8px;border-width:0 0 3px 3px}
  .br span:nth-child(4){bottom:8px;right:8px;border-width:0 3px 3px 0}

  .flash{position:absolute;inset:0;border-radius:10px;
    background:rgba(240,192,64,.4);opacity:0;pointer-events:none;z-index:10;transition:opacity .05s}
  .flash.on{opacity:1}

  .cam-idle{position:absolute;inset:0;display:flex;flex-direction:column;
    align-items:center;justify-content:center;gap:10px;color:var(--muted);
    font-family:'JetBrains Mono',monospace;font-size:.78rem}
  .cam-idle svg{opacity:.25}

  /* big capture button overlay */
  .capture-btn-wrap{
    position:absolute;bottom:12px;left:50%;transform:translateX(-50%);
    z-index:5;display:none;
  }
  #captureBtn{
    background:var(--accent);color:#08090b;border:none;border-radius:50%;
    width:60px;height:60px;font-size:1.5rem;cursor:pointer;
    box-shadow:0 0 20px rgba(240,192,64,.5);
    display:flex;align-items:center;justify-content:center;
  }
  #captureBtn:active{transform:scale(.93)}

  #dbg{font-family:'JetBrains Mono',monospace;font-size:.63rem;
    color:var(--muted);margin-top:7px;min-height:15px;text-align:center;
    word-break:break-all}

  /* mode tabs */
  .tabs{display:flex;gap:0;border:1px solid var(--border);border-radius:8px;overflow:hidden;margin-bottom:14px}
  .tab{flex:1;padding:8px;font-family:'JetBrains Mono',monospace;font-size:.72rem;
    font-weight:600;border:none;cursor:pointer;background:transparent;
    color:var(--muted);transition:all .15s;letter-spacing:.03em}
  .tab.active{background:var(--accent);color:#08090b}

  /* buttons */
  .btn-row{display:flex;gap:10px;flex-wrap:wrap;margin-top:12px}
  button{font-family:'Syne',sans-serif;font-size:.8rem;font-weight:600;
    padding:9px 18px;border-radius:8px;border:none;cursor:pointer;
    transition:all .15s;letter-spacing:.02em;white-space:nowrap}
  .btn-y{background:var(--accent);color:#08090b}
  .btn-y:hover{filter:brightness(1.15);transform:translateY(-1px)}
  .btn-g{background:var(--green);color:#08090b}
  .btn-g:hover{filter:brightness(1.1);transform:translateY(-1px)}
  .btn-b{background:var(--blue);color:#08090b}
  .btn-b:hover{filter:brightness(1.1);transform:translateY(-1px)}
  .btn-ghost{background:transparent;color:var(--text);border:1px solid var(--border)}
  .btn-ghost:hover{border-color:var(--accent);color:var(--accent)}
  .btn-danger{background:transparent;color:var(--red);border:1px solid rgba(255,85,85,.3);font-size:.72rem;padding:7px 13px}
  .btn-danger:hover{background:rgba(255,85,85,.08)}
  .btn-sm{padding:6px 12px;font-size:.72rem}
  .ml{margin-left:auto}
  button:disabled{opacity:.35;pointer-events:none}
  #stopBtn{display:none}

  /* toast */
  .toast{font-family:'JetBrains Mono',monospace;font-size:.72rem;
    padding:9px 13px;border-radius:8px;display:none}
  .toast.ok {background:rgba(61,220,132,.1);color:var(--green);border:1px solid rgba(61,220,132,.25);display:block}
  .toast.err{background:rgba(255,85,85,.1);color:var(--red);border:1px solid rgba(255,85,85,.25);display:block}
  .toast.inf{background:rgba(79,163,255,.1);color:var(--blue);border:1px solid rgba(79,163,255,.25);display:block}

  /* file input */
  #fileInput{display:none}
  .file-drop{
    border:2px dashed var(--border);border-radius:10px;padding:28px;
    text-align:center;font-family:'JetBrains Mono',monospace;font-size:.75rem;
    color:var(--muted);cursor:pointer;transition:border-color .2s;
    display:none
  }
  .file-drop:hover,.file-drop.drag{border-color:var(--accent);color:var(--accent)}
  #imgPreview{width:100%;border-radius:8px;margin-top:10px;display:none;max-height:220px;object-fit:contain}

  /* textarea */
  textarea{width:100%;background:var(--surf2);border:1px solid var(--border);
    border-radius:8px;color:var(--text);font-family:'JetBrains Mono',monospace;
    font-size:.76rem;padding:12px;resize:vertical;min-height:95px;
    outline:none;transition:border-color .2s;line-height:1.6}
  textarea:focus{border-color:var(--accent)}
  textarea::placeholder{color:var(--muted)}

  /* pool */
  .pool-hdr{display:flex;align-items:center;gap:10px;flex-wrap:wrap;margin-bottom:12px}
  .pool-hdr .clabel{margin-bottom:0}
  .badge{font-family:'JetBrains Mono',monospace;font-size:.62rem;padding:3px 10px;border-radius:20px}
  .bdg-g{background:rgba(61,220,132,.1);color:var(--green);border:1px solid rgba(61,220,132,.2)}

  .tbl-wrap{overflow-x:auto;border-radius:8px;border:1px solid var(--border)}
  table{width:100%;border-collapse:collapse;font-size:.73rem;font-family:'JetBrains Mono',monospace}
  thead tr{background:rgba(240,192,64,.05);border-bottom:1px solid var(--border)}
  thead th{padding:7px 10px;text-align:left;font-size:.59rem;text-transform:uppercase;
    letter-spacing:.1em;color:var(--accent);white-space:nowrap}
  tbody tr{border-bottom:1px solid var(--border);transition:background .1s}
  tbody tr:last-child{border-bottom:none}
  tbody tr:hover{background:rgba(255,255,255,.02)}
  tbody td{padding:7px 10px;color:var(--text);white-space:nowrap}
  .xbtn{background:none;border:none;color:var(--muted);cursor:pointer;
    font-size:.8rem;padding:2px 6px;border-radius:4px}
  .xbtn:hover{color:var(--red);background:rgba(255,85,85,.1)}
  .empty{text-align:center;padding:26px;color:var(--muted);
    font-family:'JetBrains Mono',monospace;font-size:.73rem;line-height:1.9}

  .csv-pre{background:var(--surf2);border:1px solid var(--border);border-radius:8px;
    padding:11px;font-family:'JetBrains Mono',monospace;font-size:.68rem;
    color:var(--muted);white-space:pre;overflow-x:auto;
    max-height:110px;overflow-y:auto;line-height:1.7;margin-top:12px}
</style>
</head>
<body>

<div class="hdr">
  <h1>QR â†’ CSV</h1>
  <p>scan Â· save Â· export &nbsp;Â·&nbsp; works offline</p>
</div>

<div class="wrap">

  <!-- INPUT CARD -->
  <div class="card">
    <div class="tabs">
      <button class="tab active" onclick="switchTab('camera')">ğŸ“· Camera</button>
      <button class="tab" onclick="switchTab('photo')">ğŸ–¼ Photo</button>
      <button class="tab" onclick="switchTab('paste')">ğŸ“‹ Paste</button>
    </div>

    <!-- CAMERA TAB -->
    <div id="tabCamera">
      <div class="cam-wrap">
        <video id="video" playsinline autoplay muted></video>
        <canvas id="canvas"></canvas>
        <div class="scan-line" id="scanLine"></div>
        <div class="br" id="br"><span></span><span></span><span></span><span></span></div>
        <div class="flash" id="flash"></div>
        <div class="cam-idle" id="camIdle">
          <svg width="42" height="42" fill="none" stroke="currentColor" stroke-width="1.4" viewBox="0 0 24 24">
            <path d="M3 9V6a1 1 0 0 1 1-1h3M3 15v3a1 1 0 0 0 1 1h3M21 9V6a1 1 0 0 0-1-1h-3M21 15v3a1 1 0 0 1-1 1h-3"/>
            <rect x="7" y="7" width="4" height="4" rx="0.5"/><rect x="13" y="7" width="4" height="4" rx="0.5"/>
            <rect x="7" y="13" width="4" height="4" rx="0.5"/>
          </svg>
          <span>tap Start Camera</span>
        </div>
        <!-- Manual capture button shown when auto-detect fails -->
        <div class="capture-btn-wrap" id="captureWrap">
          <button id="captureBtn" onclick="captureFrame()" title="Tap to scan QR">â¬¤</button>
        </div>
      </div>
      <div id="dbg">â€”</div>
      <div class="btn-row">
        <button class="btn-y" id="startBtn" onclick="startCamera()">Start Camera</button>
        <button class="btn-ghost" id="stopBtn" onclick="stopCamera()">Stop</button>
      </div>
    </div>

    <!-- PHOTO TAB -->
    <div id="tabPhoto" style="display:none">
      <div class="clabel">Upload a photo of a QR code</div>
      <div class="file-drop" id="fileDrop" onclick="document.getElementById('fileInput').click()"
        ondragover="event.preventDefault();this.classList.add('drag')"
        ondragleave="this.classList.remove('drag')"
        ondrop="onDrop(event)">
        tap to choose photo or drag &amp; drop
      </div>
      <input type="file" id="fileInput" accept="image/*" onchange="onFileSelect(event)">
      <img id="imgPreview" alt="QR preview">
      <canvas id="photoCanvas" style="display:none"></canvas>
    </div>

    <!-- PASTE TAB -->
    <div id="tabPaste" style="display:none">
      <div class="clabel">Paste JSON text</div>
      <textarea id="pasteBox" placeholder='{"Name":"...","SeatNo":"...","SID":"...","SchoolIndexNo":"..."}
One or multiple records'></textarea>
      <div class="btn-row">
        <button class="btn-g" onclick="parsePaste()">Parse &amp; Save</button>
        <button class="btn-ghost btn-sm" onclick="document.getElementById('pasteBox').value=''">Clear</button>
      </div>
    </div>
  </div>

  <div id="toast" class="toast"></div>

  <!-- POOL -->
  <div class="card">
    <div class="pool-hdr">
      <div class="clabel">Saved Pool</div>
      <span class="badge bdg-g" id="poolBadge">0 records</span>
      <div class="ml" style="display:flex;gap:8px;flex-wrap:wrap">
        <button class="btn-b" onclick="exportCSV()">&#x2193; Export CSV</button>
        <button class="btn-danger btn-sm" onclick="clearPool()">Clear All</button>
      </div>
    </div>
    <div class="tbl-wrap">
      <table>
        <thead><tr><th>#</th><th>School Index</th><th>Seat No</th><th>SID No</th><th>Name</th><th></th></tr></thead>
        <tbody id="poolBody">
          <tr><td colspan="6"><div class="empty">// pool is empty<br>scan a QR, upload photo, or paste JSON</div></td></tr>
        </tbody>
      </table>
    </div>
    <div class="clabel" style="margin-top:13px">CSV Preview</div>
    <div class="csv-pre" id="csvBox">â€”</div>
  </div>

</div>

<script>
// â•â• IndexedDB â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const DB_NAME='ExamQR_v3', STORE='records';
let db;
function openDB(){
  return new Promise((res,rej)=>{
    const req=indexedDB.open(DB_NAME,1);
    req.onupgradeneeded=e=>{
      if(!e.target.result.objectStoreNames.contains(STORE))
        e.target.result.createObjectStore(STORE,{keyPath:'id',autoIncrement:true});
    };
    req.onsuccess=e=>{db=e.target.result;res();};
    req.onerror=rej;
  });
}
const dbAll =()=>new Promise((r,j)=>{const q=db.transaction(STORE,'readonly').objectStore(STORE).getAll();q.onsuccess=()=>r(q.result);q.onerror=j;});
const dbAdd =row=>new Promise((r,j)=>{const tx=db.transaction(STORE,'readwrite');tx.objectStore(STORE).add(row);tx.oncomplete=r;tx.onerror=j;});
const dbMany=rows=>new Promise((r,j)=>{const tx=db.transaction(STORE,'readwrite');const s=tx.objectStore(STORE);rows.forEach(x=>s.add(x));tx.oncomplete=r;tx.onerror=j;});
const dbDel =id=>new Promise((r,j)=>{const tx=db.transaction(STORE,'readwrite');tx.objectStore(STORE).delete(id);tx.oncomplete=r;tx.onerror=j;});
const dbClr =()=>new Promise((r,j)=>{const tx=db.transaction(STORE,'readwrite');tx.objectStore(STORE).clear();tx.oncomplete=r;tx.onerror=j;});

// â•â• State â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let pool=[], scanning=false, videoStream=null, rafId=null;
let lastCode='', lastAt=0, autoDetecting=false;
const COOLDOWN=3000;
let detector=null;
const hasBarcode='BarcodeDetector' in window;

openDB().then(dbAll).then(rows=>{pool=rows;renderPool();});

if(hasBarcode){
  try{detector=new BarcodeDetector({formats:['qr_code']});}catch(e){detector=null;}
}

// â•â• Tabs â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function switchTab(name){
  ['camera','photo','paste'].forEach(t=>{
    document.getElementById('tab'+t.charAt(0).toUpperCase()+t.slice(1)).style.display=t===name?'':'none';
  });
  document.querySelectorAll('.tab').forEach((b,i)=>{
    b.classList.toggle('active',['camera','photo','paste'][i]===name);
  });
  if(name!=='camera') stopCamera();
}

// â•â• Camera â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function startCamera(){
  if(!navigator.mediaDevices||!navigator.mediaDevices.getUserMedia){
    showToast('Camera not available','err'); return;
  }
  try{
    videoStream=await navigator.mediaDevices.getUserMedia({
      video:{facingMode:{ideal:'environment'},width:{ideal:1280},height:{ideal:1280}}
    });
  }catch(e){
    showToast('Camera denied â€” check browser permissions','err');
    dbg('ERROR: '+e.name+': '+e.message); return;
  }
  const video=document.getElementById('video');
  video.srcObject=videoStream;
  try{await video.play();}catch(e){}

  scanning=true;
  document.getElementById('camIdle').style.display='none';
  document.getElementById('scanLine').style.display='block';
  document.getElementById('br').style.display='block';
  document.getElementById('startBtn').style.display='none';
  document.getElementById('stopBtn').style.display='inline-block';

  if(hasBarcode && detector){
    dbg('Auto-detecting (BarcodeDetector)â€¦');
    showToast('Camera active â€” point at QR','inf');
    autoDetecting=true;
    autoLoop();
    // After 4 seconds, if nothing scanned, show manual capture button
    setTimeout(()=>{
      if(scanning && autoDetecting){
        document.getElementById('captureWrap').style.display='block';
        dbg('Auto-detect running Â· tap â¬¤ to force-scan a frame');
      }
    },4000);
  } else {
    // No BarcodeDetector â€” go straight to manual capture
    document.getElementById('captureWrap').style.display='block';
    dbg('Tap â¬¤ button to scan QR frame');
    showToast('Point at QR then tap the button','inf');
  }
}

function stopCamera(){
  scanning=false; autoDetecting=false;
  cancelAnimationFrame(rafId);
  if(videoStream) videoStream.getTracks().forEach(t=>t.stop());
  videoStream=null;
  const video=document.getElementById('video');
  video.srcObject=null;
  document.getElementById('camIdle').style.display='flex';
  document.getElementById('scanLine').style.display='none';
  document.getElementById('br').style.display='none';
  document.getElementById('captureWrap').style.display='none';
  document.getElementById('startBtn').style.display='inline-block';
  document.getElementById('stopBtn').style.display='none';
  dbg('Camera stopped');
}

// Auto loop using BarcodeDetector
async function autoLoop(){
  if(!scanning||!autoDetecting) return;
  const video=document.getElementById('video');
  if(video.readyState>=2 && detector){
    try{
      const codes=await detector.detect(video);
      if(codes.length){await onCode(codes[0].rawValue);rafId=requestAnimationFrame(autoLoop);return;}
    }catch(e){}
    // Also try via canvas
    try{
      const c=document.getElementById('canvas');
      c.width=video.videoWidth||640; c.height=video.videoHeight||640;
      c.getContext('2d').drawImage(video,0,0,c.width,c.height);
      const bmp=await createImageBitmap(c);
      const codes=await detector.detect(bmp);
      bmp.close();
      if(codes.length){await onCode(codes[0].rawValue);rafId=requestAnimationFrame(autoLoop);return;}
    }catch(e){}
  }
  rafId=requestAnimationFrame(autoLoop);
}

// Manual capture â€” grab frame, try decode
async function captureFrame(){
  const video=document.getElementById('video');
  if(!video.srcObject){showToast('Start camera first','err');return;}

  const c=document.getElementById('canvas');
  const vw=video.videoWidth||640, vh=video.videoHeight||640;
  c.width=vw; c.height=vh;
  c.getContext('2d').drawImage(video,0,0,vw,vh);
  dbg('Frame captured '+vw+'Ã—'+vh+' â€” decodingâ€¦');

  if(detector){
    // Try BarcodeDetector on canvas blob
    try{
      c.toBlob(async blob=>{
        const url=URL.createObjectURL(blob);
        const img=new Image();
        img.onload=async()=>{
          try{
            const codes=await detector.detect(img);
            URL.revokeObjectURL(url);
            if(codes.length){await onCode(codes[0].rawValue);}
            else{showToast('No QR found â€” try again','err');dbg('No QR in frame â€” try closer/better light');}
          }catch(e){
            URL.revokeObjectURL(url);
            showToast('Detection failed: '+e.message,'err');
            dbg('ERR: '+e.message);
          }
        };
        img.src=url;
      },'image/jpeg',0.95);
    }catch(e){dbg('blob err: '+e.message);}
  } else {
    showToast('QR detection not supported in this browser','err');
    dbg('BarcodeDetector unavailable â€” try Photo tab or Paste tab');
  }
}

// â•â• Photo upload â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function onFileSelect(e){
  const file=e.target.files[0];
  if(file) processImageFile(file);
}
function onDrop(e){
  e.preventDefault();
  document.getElementById('fileDrop').classList.remove('drag');
  const file=e.dataTransfer.files[0];
  if(file) processImageFile(file);
}

async function processImageFile(file){
  const url=URL.createObjectURL(file);
  const img=document.getElementById('imgPreview');
  img.src=url; img.style.display='block';
  document.getElementById('fileDrop').style.display='none';

  showToast('Reading QR from imageâ€¦','inf');

  if(!detector){
    showToast('QR detection not supported â€” use Paste tab','err'); return;
  }

  // Wait for img to load
  await new Promise(res=>{img.onload=res;});

  try{
    const codes=await detector.detect(img);
    URL.revokeObjectURL(url);
    if(codes.length){
      await onCode(codes[0].rawValue);
    } else {
      showToast('No QR code found in image','err');
    }
  }catch(e){
    showToast('Read error: '+e.message,'err');
  }

  // Reset for next
  setTimeout(()=>{
    img.style.display='none';
    document.getElementById('fileDrop').style.display='block';
    document.getElementById('fileInput').value='';
  },2000);
}

// â•â• Handle decoded QR value â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function onCode(raw){
  const now=Date.now();
  if(raw===lastCode&&(now-lastAt)<COOLDOWN) return;
  lastCode=raw; lastAt=now;
  dbg('Decoded: '+raw.slice(0,50));
  const record=tryParse(raw);
  if(!record){showToast('QR read but not exam JSON','err');dbg('Not valid exam JSON');return;}
  await dbAdd(record);
  pool=await dbAll();
  renderPool();
  flashScreen();
  if(navigator.vibrate) navigator.vibrate([80,30,50]);
  showToast('âœ“ Saved: '+record.name,'ok');
  dbg('Saved â†’ '+record.name);
}

// â•â• Paste â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function parsePaste(){
  const raw=document.getElementById('pasteBox').value.trim();
  if(!raw){showToast('Nothing to parse','err');return;}
  const found=[],errs=[0];
  let depth=0,start=-1;
  for(let i=0;i<raw.length;i++){
    if(raw[i]==='{'){if(depth===0)start=i;depth++;}
    else if(raw[i]==='}'){
      depth--;
      if(depth===0&&start!==-1){
        try{found.push(JSON.parse(raw.slice(start,i+1)));}catch(e){errs[0]++;}
        start=-1;
      }
    }
  }
  if(!found.length){showToast('No valid JSON found','err');return;}
  const records=found.map(mapObj).filter(r=>r.name||r.seatNo);
  if(!records.length){showToast('JSON found but missing exam fields','err');return;}
  await dbMany(records);
  pool=await dbAll();
  renderPool();
  document.getElementById('pasteBox').value='';
  showToast('Saved '+records.length+' record(s) Â· total: '+pool.length,'ok');
}

// â•â• Helpers â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function tryParse(text){
  const m=text.match(/\{[\s\S]*\}/);
  if(!m) return null;
  try{const o=JSON.parse(m[0]);const r=mapObj(o);return(r.name||r.seatNo)?r:null;}
  catch(e){return null;}
}
function mapObj(o){return{schoolIndex:t(o.SchoolIndexNo),seatNo:t(o.SeatNo),sid:t(o.SID),name:t(o.Name)};}
function t(v){return(v||'').toString().trim();}
function flashScreen(){const f=document.getElementById('flash');f.classList.add('on');setTimeout(()=>f.classList.remove('on'),160);}

// â•â• Delete / Clear â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function delRow(id){await dbDel(id);pool=await dbAll();renderPool();}
async function clearPool(){
  if(!pool.length) return;
  if(!confirm('Delete all '+pool.length+' saved records?')) return;
  await dbClr();pool=[];renderPool();showToast('Pool cleared','inf');
}

// â•â• Export â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function exportCSV(){
  if(!pool.length){showToast('Nothing to export','err');return;}
  const csv=buildCSV(pool);
  const blob=new Blob(['\uFEFF'+csv],{type:'text/csv;charset=utf-8;'});
  const url=URL.createObjectURL(blob);
  const a=document.createElement('a');
  a.setAttribute('href',url);
  a.setAttribute('download','exam_'+new Date().toISOString().slice(0,10)+'.csv');
  document.body.appendChild(a);a.click();document.body.removeChild(a);
  setTimeout(()=>URL.revokeObjectURL(url),1000);
  showToast('Exported '+pool.length+' records','ok');
}

// â•â• Render â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderPool(){
  document.getElementById('poolBadge').textContent=pool.length+' record'+(pool.length!==1?'s':'');
  if(!pool.length){
    document.getElementById('poolBody').innerHTML='<tr><td colspan="6"><div class="empty">// pool is empty<br>scan a QR, upload photo, or paste JSON</div></td></tr>';
    document.getElementById('csvBox').textContent='â€”';
    return;
  }
  document.getElementById('poolBody').innerHTML=pool.map((r,i)=>`
    <tr>
      <td style="color:var(--muted)">${i+1}</td>
      <td>${x(r.schoolIndex)}</td><td>${x(r.seatNo)}</td>
      <td>${x(r.sid)}</td><td>${x(r.name)}</td>
      <td><button class="xbtn" onclick="delRow(${r.id})">&#x2715;</button></td>
    </tr>`).join('');
  document.getElementById('csvBox').textContent=buildCSV(pool);
}
function buildCSV(rows){
  return['School Index,Seat No,SID No,Name',...rows.map(r=>[r.schoolIndex,r.seatNo,r.sid,r.name].map(cf).join(','))].join('\n');
}
function cf(v){v=(v||'').toString();return/[,"\n]/.test(v)?'"'+v.replace(/"/g,'""')+'"':v;}
function x(s){return(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');}

// â•â• Toast + debug â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let tt;
function showToast(msg,type){
  const el=document.getElementById('toast');
  el.textContent=msg;el.className='toast '+type;
  clearTimeout(tt);tt=setTimeout(()=>el.className='toast',4500);
}
function dbg(msg){document.getElementById('dbg').textContent='// '+msg;}

// Show file drop on load
document.getElementById('fileDrop').style.display='block';
</script>
</body>
</html>
